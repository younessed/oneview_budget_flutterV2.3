workflows:
  android-apk:
    name: OneView Budget APK
    max_build_duration: 60
    environment:
      flutter: 3.22.2
      java: 17

    scripts:
      - name: VÃ©rifier les versions
        script: |
          flutter --version
          dart --version

      - name: Nettoyage & dÃ©pendances
        script: |
          flutter clean
          flutter pub get
          # ðŸ‘‰ Donner les droits d'exÃ©cution au wrapper Gradle
          chmod +x android/gradlew
          # Nettoyage Gradle (optionnel mais propre)
          ./android/gradlew -p android clean

      - name: Construction APK (via Gradle)
        script: |
          set -euxo pipefail
          chmod +x android/gradlew
          ./android/gradlew -p android :app:assembleRelease
          echo "== APKs trouvÃ©s =="
          find android/app/build/outputs/apk -type f -name "*.apk" -print

      - name: Collecte des artefacts
        script: |
          mkdir -p cm_artifacts
          cp -v android/app/build/outputs/apk/release/*.apk cm_artifacts/ || true
          cp -v android/app/build/outputs/apk/**/*.apk cm_artifacts/ || true
          echo "== Contenu cm_artifacts =="
          ls -la cm_artifacts || true

    artifacts:
      - cm_artifacts/*.apk
      - android/app/build/outputs/apk/**/*.apk
